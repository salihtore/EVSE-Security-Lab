<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EVSE Thermal Spoofing – Real-Time Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
    }
    h1 { margin: 0 0 10px 0; }
    .status-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      font-size: 14px;
    }
    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #4b5563;
    }
    .running { border-color: #16a34a; color: #4ade80; }
    .stopped { border-color: #b91c1c; color: #fca5a5; }
    .attack-on { border-color: #3b82f6; color: #93c5fd; }
    .attack-off { border-color: #475569; color: #cbd5f5; }
    .anomaly-on { border-color: #ef4444; color: #fecaca; }
    .anomaly-off { border-color: #10b981; color: #6ee7b7; }
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1fr);
      gap: 20px;
    }
    .card {
      background: #020617;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.45);
    }
    canvas {
      width: 100% !important;
      height: 260px !important;
    }
    .label-row {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 6px;
    }
    .reason {
      font-size: 13px;
      color: #e5e7eb;
      min-height: 32px;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h1>⚡ EVSE Thermal Spoofing – Real-Time Dashboard</h1>
  <div class="status-bar">
    <div id="statusBadge" class="badge running">Durum: Running</div>
    <div id="anomalyBadge" class="badge anomaly-off">Anomaly: None</div>
    <div id="attackBadge" class="badge attack-off">Attack Mode: false</div>
    <div id="stepBadge" class="badge">Step: 0</div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="label-row">Real vs Measured Temperature (°C)</div>
      <canvas id="tempChart"></canvas>
    </div>
    <div class="card">
      <div class="label-row">Current (A)</div>
      <canvas id="currentChart"></canvas>
    </div>
  </div>

  <div class="card" style="margin-top:20px;">
    <div class="label-row">Anomaly Reason</div>
    <div id="reasonBox" class="reason">–</div>
  </div>

  <script>
    const tempCtx = document.getElementById('tempChart').getContext('2d');
    const currentCtx = document.getElementById('currentChart').getContext('2d');

    const tempLabels = [];
    const realTempData = [];
    const measuredTempData = [];
    const currentLabels = [];
    const currentData = [];

    const tempChart = new Chart(tempCtx, {
      type: 'line',
      data: {
        labels: tempLabels,
        datasets: [
          {
            label: 'Real Temp (physical)',
            data: realTempData,
            borderWidth: 2,
            tension: 0.25
          },
          {
            label: 'Measured Temp (reported)',
            data: measuredTempData,
            borderWidth: 2,
            borderDash: [5, 5],
            tension: 0.25
          }
        ]
      },
      options: {
        animation: false,
        responsive: true,
        scales: {
          x: {
            ticks: { color: '#9ca3af' },
            grid: { color: '#111827' }
          },
          y: {
            ticks: { color: '#9ca3af' },
            grid: { color: '#111827' }
          }
        },
        plugins: {
          legend: {
            labels: { color: '#e5e7eb' }
          }
        }
      }
    });

    const currentChart = new Chart(currentCtx, {
      type: 'line',
      data: {
        labels: currentLabels,
        datasets: [
          {
            label: 'Current (A)',
            data: currentData,
            borderWidth: 2,
            tension: 0.25
          }
        ]
      },
      options: {
        animation: false,
        responsive: true,
        scales: {
          x: {
            ticks: { color: '#9ca3af' },
            grid: { color: '#111827' }
          },
          y: {
            ticks: { color: '#9ca3af' },
            grid: { color: '#111827' }
          }
        },
        plugins: {
          legend: {
            labels: { color: '#e5e7eb' }
          }
        }
      }
    });

    const statusBadge = document.getElementById('statusBadge');
    const anomalyBadge = document.getElementById('anomalyBadge');
    const attackBadge = document.getElementById('attackBadge');
    const stepBadge = document.getElementById('stepBadge');
    const reasonBox = document.getElementById('reasonBox');

    const ws = new WebSocket("ws://" + window.location.host + "/ws");

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      const step = data.step ?? 0;
      const tReal = data.temp_real ?? 0;
      const tMeas = data.temp ?? 0;
      const current = data.current ?? 0;
      const attack = !!data.attack;
      const anomaly = !!data.anomaly;
      const reason = data.reason || "";

      // label = step
      tempLabels.push(step);
      realTempData.push(tReal);
      measuredTempData.push(tMeas);
      currentLabels.push(step);
      currentData.push(current);

      // 100 noktadan fazlasını tutma
      if (tempLabels.length > 100) {
        tempLabels.shift();
        realTempData.shift();
        measuredTempData.shift();
      }
      if (currentLabels.length > 100) {
        currentLabels.shift();
        currentData.shift();
      }

      tempChart.update();
      currentChart.update();

      // Status bar
      stepBadge.textContent = "Step: " + step;

      attackBadge.textContent = "Attack Mode: " + attack;
      attackBadge.className = "badge " + (attack ? "attack-on" : "attack-off");

      anomalyBadge.textContent = "Anomaly: " + (anomaly ? "Detected" : "None");
      anomalyBadge.className = "badge " + (anomaly ? "anomaly-on" : "anomaly-off");

      statusBadge.textContent = "Durum: Running";
      statusBadge.className = "badge running";

      reasonBox.textContent = reason || "–";
    };
  </script>
</body>
</html>
